var $=Object.defineProperty;var T=(o,t,e)=>t in o?$(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var m=(o,t,e)=>(T(o,typeof t!="symbol"?t+"":t,e),e);import{r as i,a as q,_ as O,j as c,I as U,L as F}from"./index-aJe0aa89.js";import{u as W,a as z}from"./utils-40nqDg4W.js";import{K as G,R as H}from"./index-DrfVd3mt.js";import{L as Q}from"./index-t1siDvdY.js";import{u as X}from"./useQuery-DjHnRFo0.js";class Y{constructor({parent:t,element:e,start:f,end:u,initial:l,height:h,content:x,className:b}){m(this,"elem");m(this,"start");m(this,"end");m(this,"initial");m(this,"height");var y;if(e??(e=(()=>{const p=document.createElement("span");return p.classList.add(b),t.appendChild(p),p})()),this.elem=e,this.content=x,this.opacity="0",this.start=f??Number(e.dataset.start),isNaN(this.start))throw new Error("`.drifting` must have a `data-start` time or `Drifting` must have `{start}`.");this.end=u??Number(e.dataset.end??this.start+2500),(y=e.dataset).x??(y.x=String(20+Math.random()*60)),this.initial={x:(l==null?void 0:l.x)??Number(e.dataset.x),y:(l==null?void 0:l.y)??Number(e.dataset.y??0)},this.height=h??Number(e.dataset.height??40)}set left(t){this.elem.style.left=t}set top(t){this.elem.style.top=t}set opacity(t){this.elem.style.opacity=String(t)}set content(t){let e;/^(https?|ipfs):\/\//.test(t)?(e=document.createElement("img"),e.src=t):(e=document.createElement("span"),e.textContent=t),e.className="emoji",this.elem.replaceChildren(e)}set time(t){if(t>=this.start&&t<=this.end){const e=(t-this.start)/(this.end-this.start),f=`${this.initial.x+Math.cos(6*Math.PI*e)}%`;this.left=f;const u=`${this.initial.y-this.height*e}%`;this.top=u,this.opacity=1-e}else this.opacity=0}toString(){return`Drifter(${this.start}–${this.end}, <${this.initial.x}, ${this.initial.y}>, ${this.elem.textContent})`}}const B="_reactor_1ta6m_1",J="_video_1ta6m_2",V="_overlay_1ta6m_1",Z="_drifting_1ta6m_18",ee="_home_1ta6m_34",g={reactor:B,video:J,overlay:V,drifting:Z,"onscreen-keymap":"_onscreen-keymap_1ta6m_1",home:ee},ne=()=>{const o=i.useRef(null),t=i.useRef(null),e=i.useRef(null),f=i.useRef([]),[u,l]=i.useState(null),[h,x]=i.useState(!0),[b,y]=i.useState(),[p,_]=i.useState(!1),{supabase:n,error:N}=W();N&&console.error({supaError:N});const{uuid:v}=q(),{error:R,data:w}=X({queryKey:["Reactor",{uuid:v,supabase:n}],queryFn:async()=>{if(!n)throw new Error("Supabase not initialized.");const{data:r,error:a}=await(n==null?void 0:n.from("videos").select().eq("id",v).single())??{};if(a)throw a;return r},enabled:!!n});R&&console.error({queryError:R});const A=i.useCallback(()=>{if(e.current){const r=e.current.currentTime*1e3;f.current.forEach(a=>a.time=r)}},[]);z(A);const d=i.useCallback(r=>{var a;if(!e.current)throw new Error("<video> ref is not set.");switch(r.key){case"Escape":{document.addEventListener("keyup",d),(a=o.current)==null||a.close(),_(!1),h&&e.current.play();break}case"e":{l({time:e.current.currentTime*1e3}),_(!0);break}case" ":{e.current.paused?e.current.play():e.current.pause();break}case"ArrowLeft":case"ArrowRight":{let s=10;r.shiftKey&&(s*=2),r.ctrlKey&&(s/=2),r.key==="ArrowLeft"&&(s*=-1),e.current.currentTime+=e.current.duration/s;break}case"ArrowUp":case"ArrowDown":{let s=1;r.shiftKey&&(s*=2),r.ctrlKey&&(s/=2),r.key==="ArrowDown"&&(s*=-1),e.current.currentTime+=s;break}case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":{let s=Number(r.key);s===0&&(s=.5),e.current.playbackRate=s,O(`Playback ⨯${s}`);break}default:console.debug({key:r.key})}},[h]),M=i.useCallback(r=>{var k;if(!e.current)throw new Error("<video> not found.");const a={x:r.clientX,y:r.clientY},s={x:a.x/e.current.clientWidth*100,y:a.y/e.current.clientHeight*100};y(s),l({at:s,time:e.current.currentTime*1e3}),x(!e.current.paused),e.current.pause(),document.removeEventListener("keyup",d),(k=o.current)==null||k.showModal()},[d]),K=i.useCallback(()=>{var r;document.addEventListener("keyup",d),(r=o.current)==null||r.close()},[d]),D=async(r,a)=>{if(a.stopPropagation(),!u)throw new Error("Emoji selected without initial config.");if(!u.at||!u.time)throw new Error("Emoji selected without complete config.");if(!e.current)throw new Error("<video> ref is not set.");if(!t.current)throw new Error("Overlay ref is not set.");const s=u.time,k=u.time+4*1e3,j=u.at,E=r.image;if(!E)throw new Error("Reaction has no emoji.");if(f.current.push(new Y({start:s,end:k,initial:j,content:E,parent:t.current,className:g.drifting})),l(null),h&&e.current.play(),n){const{data:S}=await n.from("feedbacks").select().eq("image",E).single();let L=S==null?void 0:S.id;if(!L){const{data:P,error:C}=await n.from("feedbacks").insert({image:E}).select().single();if(L=P.id,C)throw C}await(n==null?void 0:n.from("reactions").insert({start_time:new Date(s).toISOString().split("T").at(-1),end_time:new Date(k).toISOString().split("T").at(-1),initial_x:Math.round(j.x),initial_y:Math.round(j.y),video_id:v,feedback_id:L}))}};i.useEffect(()=>(document.addEventListener("keyup",d),()=>{document.removeEventListener("keyup",d)}),[d]);const I=r=>{var a;if(!e.current)throw new Error("<video> ref is not set.");y(r),_(!1),l({...u,at:r}),x(!e.current.paused),e.current.pause(),(a=o.current)==null||a.showModal()};return c.jsxs("article",{id:g.reactor,children:[c.jsx(U,{}),c.jsxs("section",{className:g.video,children:[w?c.jsxs("video",{controls:!0,muted:!0,autoPlay:!0,ref:e,children:[c.jsx("source",{src:w.url}),c.jsx("track",{default:!0,src:"animated.vtt",kind:"subtitles",label:"Animated"})]}):c.jsx("h3",{children:"Loading…"}),c.jsx("div",{id:g.overlay,ref:t,onClick:M}),c.jsx(G,{active:p,onSelect:I})]}),c.jsx(F,{to:"/",className:g.home,children:c.jsx(Q,{})}),c.jsx(H,{feedbackGroupIds:[w==null?void 0:w.feedback_group_id],ref:o,onSelect:D,onClose:K,center:b})]})};export{ne as Reactor,ne as default};
