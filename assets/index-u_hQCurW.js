import{r as l,j as r,a as q}from"./index-a8h7Vdce.js";import{u as x,e as _}from"./utils-RhknTK99.js";import{u as b}from"./useQuery-0fXINSu8.js";const R="_listGrid_q99ex_1",E="_reactions_q99ex_1",g={listGrid:R,reactions:E,"use-rubric":"_use-rubric_q99ex_21"},S=(e,n)=>b({queryKey:["feedbacks",n,e],queryFn:async()=>{const{data:s,error:c}=await e.from("feedbacks").select().in("id",n);if(c)throw c;return Object.fromEntries(s.map(({id:a,image:u})=>[a,u]))},enabled:!!e}),k=(e,n)=>b({queryKey:["rubrics",n,e],queryFn:async()=>{let s=e.from("rubrics").select("id, name, default_weight");n&&(s=s.eq("feedback_group_id",n));const{data:c,error:a}=await s;if(a)throw a;return c},enabled:!!e}),W=(e,n)=>b({queryKey:["rubrics",n,e],queryFn:async()=>{if(!e)throw new Error("`supabase` not available.");let s=e.from("feedback_weights").select("feedback_id, weight");n&&(s=s.eq("rubric_id",n));const{data:c,error:a}=await s;if(a)throw a;return Object.fromEntries(c.map(({feedback_id:u,weight:d})=>[u,d]))},enabled:!!e}),C=({video:e})=>{const n=l.useMemo(()=>{const t={};return e==null||e.reactions.forEach(({feedback_id:o})=>{t[o]??(t[o]=0),t[o]++}),t},[e==null?void 0:e.reactions]),[s,c]=l.useState(),[a,u]=l.useState({}),[d,y]=l.useState(),{supabase:h}=x(),{data:f}=S(h,Object.keys(n)),{data:i}=k(h,e==null?void 0:e.feedback_group_id),{data:m}=W(h,e==null?void 0:e.feedback_group_id);return l.useEffect(()=>{m&&u(m)},[m]),r.jsxs("section",{id:g.reactions,children:[r.jsx("h2",{children:"Weighted Reactions"}),r.jsxs("form",{className:g["use-rubric"],onSubmit:()=>{c(i==null?void 0:i.find(({id:t})=>t===d))},children:[r.jsx("input",{id:"rubric",onChange:({target:{value:t}})=>y(t),value:d??"",list:"rubrics"}),r.jsxs("datalist",{id:"rubrics",children:[r.jsx("option",{value:"",children:"Choose a Rubricâ€¦"}),i==null?void 0:i.map(({id:t,name:o})=>r.jsx("option",{value:t,children:o},t))]}),r.jsxs("nav",{children:[i&&(i==null?void 0:i.length)>0&&r.jsx("button",{children:"â¤ŸðŸ’¾ Load a Rubric"}),r.jsx("button",{type:"button",onClick:async()=>{if(e){const{data:t}=await h.from("rubrics").insert({feedback_group_id:e.feedback_group_id,name:s,default_weight:1}).single()??{};c(t)}},children:"â¤ŸðŸ—ƒ Add a Rubric"}),s&&r.jsx("button",{type:"button",onClick:()=>{u({}),c(null)},children:"â¤ŸðŸ–¥ Update a Rubric"})]})]}),r.jsx("ul",{className:g.listGrid,children:Object.entries(n).map(([t,o])=>{const j=(a==null?void 0:a[t])??(s==null?void 0:s.default_weight)??0;return r.jsxs("li",{children:[_(f==null?void 0:f[t]),r.jsx("input",{id:`count-${t}`,type:"number",value:o,readOnly:!0}),r.jsx("input",{id:`weight-${t}`,type:"number",value:j,onChange:({target:{value:p}})=>{u(w=>({...w,[t]:p}))}}),r.jsx("output",{children:(o*Number(j)).toLocaleString()})]},t)})})]})},F=C,L=()=>{const{supabase:e}=x(),{uuid:n}=q(),{data:s,isLoading:c}=b({queryKey:["score",n,{supabase:e}],queryFn:async()=>{if(!e)throw new Error("`supabase` not available.");const{data:a}=await e.from("reactions").select(`
          *,
          feedbacks(*),
          videos (*)
        `).eq("video_id",n).single();return a},enabled:!!e});return console.debug({video:s}),c?r.jsx("p",{children:"Loadingâ€¦"}):r.jsxs("article",{children:[r.jsxs("h1",{children:["Scoring: ",r.jsx("q",{children:s.title})]}),r.jsx(F,{video:s})]})};export{L as Score,L as default};
