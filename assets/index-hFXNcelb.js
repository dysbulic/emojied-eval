import{r as a,u as C,d as T,j as e,i as d,H as F,b as L}from"./index-KjuVSpxn.js";const S="_form_1b9hj_1",O="_buttons_1b9hj_36",R="_noneOption_1b9hj_46",D="_split_1b9hj_52",N={form:S,buttons:O,noneOption:R,split:D},z=a.forwardRef(({video:t,onClose:c},r)=>{var n,p;const{supabase:l}=C(),f=a.useRef(null),[i,u]=a.useState(),h=a.useCallback(()=>{var s,o;(s=f.current)==null||s.reset(),r instanceof Function||(o=r==null?void 0:r.current)==null||o.close(),c==null||c()},[r,c]);a.useEffect(()=>{if(!(r instanceof Function)){const s=h,o=r==null?void 0:r.current;return o==null||o.addEventListener("close",s),()=>o==null?void 0:o.removeEventListener("close",s)}},[h,r]);const b=async s=>{if(!l)throw new Error("Supabase not defined.");const o=s.currentTarget.elements,w={id:t==null?void 0:t.id,url:o.url.value,title:o.title.value,description:o.description.value},y=document.createElement("video");w.duration=await new Promise($=>{y.addEventListener("loadedmetadata",()=>{var V;$(((V=new Date(y.duration*1e3).toISOString().split("T").at(-1))==null?void 0:V.replace(/\w$/g,""))??null)}),y.src=w.url});const{data:k,error:E}=await l.from("videos").upsert(w).select("id").single()??{};if(E)throw E;const q=o.group.value;await l.from("feedback_groups_videos").delete().eq("video_id",k.id),q&&await l.from("feedback_groups_videos").upsert({video_id:k.id,group_id:q}),h()},{isLoading:j,error:_,data:m}=T({queryKey:["VideoForm",{supabase:l}],enabled:!!l,queryFn:async()=>{const{data:s,error:o}=await(l==null?void 0:l.from("feedback_groups").select())??{};if(o)throw o;return s}});if(_)throw _;const x=(p=(n=t==null?void 0:t.feedback_groups)==null?void 0:n[0])==null?void 0:p.id;return a.useEffect(()=>{console.debug({fbg:x}),u(x)},[x]),e.jsx("dialog",{ref:r,className:N.dialog,children:e.jsxs("form",{onSubmit:b,method:"dialog",className:d.form,ref:f,children:[e.jsxs("label",{children:[e.jsx("h3",{children:"URL"}),e.jsx("input",{id:"url",defaultValue:(t==null?void 0:t.url)??"",required:!0})]}),e.jsxs("label",{children:[e.jsx("h3",{children:"Title"}),e.jsx("input",{id:"title",defaultValue:(t==null?void 0:t.title)??"",required:!0})]}),e.jsxs("label",{children:[e.jsx("h3",{children:"Description"}),e.jsx("textarea",{id:"description",defaultValue:(t==null?void 0:t.description)??""})]}),e.jsxs("label",{children:[e.jsx("h3",{className:N.split,children:"Feedback Group"}),j?e.jsx("p",{children:"Loadingâ€¦"}):e.jsxs("select",{id:"group",value:i??"",onChange:({currentTarget:{value:s}})=>u(s),children:[e.jsx("option",{value:"",className:N.noneOption,children:"None"}),m==null?void 0:m.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),e.jsxs("div",{className:d.buttons,children:[e.jsx("button",{type:"button",onClick:h,className:d.cancel,children:"Cancel"}),e.jsx("button",{className:d.submit,children:t?"Update":"Create"})]})]})})}),G=z,H=t=>T({queryKey:["Videos",t],enabled:!!t,queryFn:async()=>{const{data:c,error:r}=await(t==null?void 0:t.from("videos").select("*, feedback_groups (*)"))??{};if(r)throw r;return c}}),K="_header_stgzj_1",U="_none_stgzj_6",I="_olTable_stgzj_12",g={header:K,none:U,olTable:I},P=()=>{const t=a.useRef(null),{supabase:c,error:r}=C(),{isLoading:l,error:f,data:i,refetch:u}=H(c),[h,b]=a.useState(null),j=async()=>{var n;(n=t.current)==null||n.showModal()},_=a.useCallback(()=>{b(null),u()},[u]),m=n=>{const p=i==null?void 0:i.find(s=>s.id===n);if(!p)throw new Error(`No video found with id: "${n}".`);b(p),j()},x=async n=>{await(c==null?void 0:c.from("videos").delete().eq("id",n)),u()};if(r)throw r;if(f)throw f;return e.jsxs("article",{id:g.outer,children:[e.jsxs(F,{children:[e.jsx("h1",{children:"Videos"}),e.jsx("button",{onClick:j,className:"square",children:"âž•"})]}),e.jsx(G,{video:h,onClose:_,ref:t}),e.jsx("main",{className:g.olTable,children:l?e.jsx("p",{children:"Loadingâ€¦"}):i&&i.length===0?e.jsxs("section",{className:g.none,children:[e.jsx("p",{children:"No videos found."}),e.jsx("button",{onClick:j,children:"Create One"})]}):e.jsx("ol",{children:i==null?void 0:i.map(n=>e.jsxs("li",{children:[e.jsx("h2",{children:e.jsx(L,{to:`/eval/${n.id}`,children:n.title})}),e.jsx("div",{children:n.description}),e.jsxs("nav",{className:`${d.options} ${d.buttons}`,children:[e.jsx("button",{className:d.edit,onClick:()=>m(n.id),children:"ðŸ–‰"}),e.jsx("button",{className:d.delete,onClick:()=>x(n.id),children:"âž–"}),e.jsx(L,{to:`/score/${n.id}`,className:d.score,children:"ðŸŽ¼"})]})]},n.id))})})]})};export{P as Videos,P as default};
