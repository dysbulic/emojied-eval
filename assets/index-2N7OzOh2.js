var U=Object.defineProperty;var F=(i,r,e)=>r in i?U(i,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[r]=e;var y=(i,r,e)=>(F(i,typeof r!="symbol"?r+"":r,e),e);import{r as n,u as W,d as z,c as G,_ as M,t as K,e as H,j as c,I as Q,b as X,f as Y}from"./index-Zw_OpJyE.js";import{K as B,R as J}from"./index-bNe2WgYg.js";class D{constructor({parent:r,element:e,start:m,end:u,initial:l,height:w,content:x,className:b}){y(this,"elem");y(this,"start");y(this,"end");y(this,"initial");y(this,"height");var g;if(e??(e=(()=>{const k=document.createElement("span");return k.classList.add(b),r.appendChild(k),k})()),this.elem=e,this.content=x,this.opacity="0",this.start=m??Number(e.dataset.start),isNaN(this.start))throw new Error("`.drifting` must have a `data-start` time or `Drifting` must have `{start}`.");this.end=u??Number(e.dataset.end??this.start+2500),(g=e.dataset).x??(g.x=String(20+Math.random()*60)),this.initial={x:(l==null?void 0:l.x)??Number(e.dataset.x),y:(l==null?void 0:l.y)??Number(e.dataset.y??0)},this.height=w??Number(e.dataset.height??40)}set left(r){this.elem.style.left=r}set top(r){this.elem.style.top=r}set opacity(r){this.elem.style.opacity=String(r)}set content(r){let e;/^(https?|ipfs):\/\//.test(r)?(e=document.createElement("img"),e.src=r):(e=document.createElement("span"),e.textContent=r),e.className="emoji",this.elem.replaceChildren(e)}set time(r){if(r>=this.start&&r<=this.end){const e=(r-this.start)/(this.end-this.start),m=`${this.initial.x+Math.cos(6*Math.PI*e)}%`;this.left=m;const u=`${this.initial.y-this.height*e}%`;this.top=u,this.opacity=1-e}else this.opacity=0}toString(){return`Drifter(${this.start}–${this.end}, <${this.initial.x}, ${this.initial.y}>, ${this.elem.textContent})`}}const V="_reactor_1ta6m_1",Z="_video_1ta6m_2",ee="_overlay_1ta6m_1",te="_drifting_1ta6m_18",re="_home_1ta6m_34",p={reactor:V,video:Z,overlay:ee,drifting:te,"onscreen-keymap":"_onscreen-keymap_1ta6m_1",home:re},ie=()=>{var L;const i=n.useRef(null),r=n.useRef(null),e=n.useRef(null),m=n.useRef([]),[u,l]=n.useState(null),[w,x]=n.useState(!0),[b,g]=n.useState(),[k,v]=n.useState(!1),{supabase:o,error:C}=W();C&&console.error({supaError:C});const{uuid:S}=z(),{error:j,data:d}=G({enabled:!!o,queryKey:["Reactor",{uuid:S,supabase:o}],queryFn:async()=>{if(!o)throw new Error("Supabase not initialized.");const{data:t,error:a}=await(o==null?void 0:o.from("videos").select(`
          *,
          feedback_groups (id, title),
          reactions (
            start_time, end_time,
            initial_x, initial_y,
            feedbacks (*)
          )
        `).eq("id",S).single())??{};if(a)throw a;return t}});j&&(console.error({queryError:j}),M.error(j.message)),n.useEffect(()=>{d&&(m.current=d.reactions.map(t=>{if(!r.current)throw new Error("Overlay ref is not set.");const a=K(t.start_time)*1e3,s=K(t.end_time)*1e3,h={x:t.initial_x,y:t.initial_y},_=t.feedbacks.image;return new D({start:a,end:s,initial:h,content:_,parent:r.current,className:p.drifting})}))},[d]);const I=n.useCallback(()=>{if(e.current){const t=e.current.currentTime*1e3;m.current.forEach(a=>a.time=t)}},[]);H(I);const f=n.useCallback(t=>{var a;if(!e.current)throw new Error("<video> ref is not set.");switch(t.key){case"Escape":{document.addEventListener("keyup",f),(a=i.current)==null||a.close(),v(!1),w&&e.current.play();break}case"e":{l({time:e.current.currentTime*1e3}),v(!0);break}case" ":{e.current.paused?e.current.play():e.current.pause();break}case"ArrowLeft":case"ArrowRight":{let s=10;t.shiftKey&&(s*=2),t.ctrlKey&&(s/=2),t.key==="ArrowLeft"&&(s*=-1),e.current.currentTime+=e.current.duration/s;break}case"ArrowUp":case"ArrowDown":{let s=1;t.shiftKey&&(s*=2),t.ctrlKey&&(s/=2),t.key==="ArrowDown"&&(s*=-1),e.current.currentTime+=s;break}case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":{const s=(()=>{switch(t.key){case"0":return .25;case"1":return .5;case"2":return 1;case"3":return 1.25;case"4":return 1.5;case"5":return 2;case"6":return 4;case"7":return 8;case"8":return 10;case"9":return 20;default:return 1}})();e.current.playbackRate=s,M(`Playback ⨯${s}`);break}}},[w]);n.useEffect(()=>(document.addEventListener("keyup",f),()=>{document.removeEventListener("keyup",f)}),[f]);const P=n.useCallback(t=>{var h;if(!e.current)throw new Error("<video> not found.");const a={x:t.clientX,y:t.clientY},s={x:a.x/e.current.clientWidth*100,y:a.y/e.current.clientHeight*100};g(s),l({at:s,time:e.current.currentTime*1e3}),x(!e.current.paused),e.current.pause(),document.removeEventListener("keyup",f),(h=i.current)==null||h.showModal()},[f]),T=n.useCallback(()=>{var t;document.addEventListener("keyup",f),(t=i.current)==null||t.close()},[f]),$=async(t,a)=>{if(a.stopPropagation(),!u)throw new Error("Emoji selected without initial config.");if(!u.at||!u.time)throw new Error("Emoji selected without complete config.");if(!e.current)throw new Error("<video> ref is not set.");if(!r.current)throw new Error("Overlay ref is not set.");const s=u.time,h=u.time+4*1e3,_=u.at,E=t.image;if(!E)throw new Error("Reaction has no emoji.");if(m.current.push(new D({start:s,end:h,initial:_,content:E,parent:r.current,className:p.drifting})),l(null),w&&e.current.play(),o){const{data:N}=await o.from("feedbacks").select().eq("image",E).single();let R=N==null?void 0:N.id;if(!R){const{data:O,error:A}=await o.from("feedbacks").insert({image:E}).select().single();if(R=O.id,A)throw A}await(o==null?void 0:o.from("reactions").insert({start_time:new Date(s).toISOString().split("T").at(-1),end_time:new Date(h).toISOString().split("T").at(-1),initial_x:Math.round(_.x),initial_y:Math.round(_.y),video_id:S,feedback_id:R}))}},q=t=>{var a;if(!e.current)throw new Error("<video> ref is not set.");g(t),v(!1),l({...u,at:t}),x(!e.current.paused),e.current.pause(),(a=i.current)==null||a.showModal()};return c.jsxs("article",{id:p.reactor,children:[c.jsx(Q,{}),c.jsxs("section",{className:p.video,children:[d?c.jsxs("video",{controls:!0,muted:!0,autoPlay:!0,ref:e,children:[c.jsx("source",{src:d.url}),c.jsx("track",{default:!0,src:"animated.vtt",kind:"subtitles",label:"Animated"})]}):c.jsx("h3",{children:"Loading…"}),c.jsx("div",{id:p.overlay,ref:r,onClick:P}),c.jsx(B,{active:k,onSelect:q})]}),c.jsx(X,{to:"/",className:p.home,children:c.jsx(Y,{})}),c.jsx(J,{feedbackGroupIds:(L=d==null?void 0:d.feedback_groups)==null?void 0:L.map(({id:t})=>t),ref:i,onSelect:$,onClose:T,center:b})]})};export{ie as Reactor,ie as default};
