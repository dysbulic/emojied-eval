var T=Object.defineProperty;var q=(i,t,e)=>t in i?T(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var m=(i,t,e)=>(q(i,typeof t!="symbol"?t+"":t,e),e);import{r as n,u as O,c as U,d as F,e as W,_ as z,j as c,I as G,b as H,f as Q}from"./index-whC2bFQp.js";import{K as X,R as Y}from"./index-7r40wDYw.js";class B{constructor({parent:t,element:e,start:h,end:u,initial:l,height:y,content:x,className:E}){m(this,"elem");m(this,"start");m(this,"end");m(this,"initial");m(this,"height");var p;if(e??(e=(()=>{const w=document.createElement("span");return w.classList.add(E),t.appendChild(w),w})()),this.elem=e,this.content=x,this.opacity="0",this.start=h??Number(e.dataset.start),isNaN(this.start))throw new Error("`.drifting` must have a `data-start` time or `Drifting` must have `{start}`.");this.end=u??Number(e.dataset.end??this.start+2500),(p=e.dataset).x??(p.x=String(20+Math.random()*60)),this.initial={x:(l==null?void 0:l.x)??Number(e.dataset.x),y:(l==null?void 0:l.y)??Number(e.dataset.y??0)},this.height=y??Number(e.dataset.height??40)}set left(t){this.elem.style.left=t}set top(t){this.elem.style.top=t}set opacity(t){this.elem.style.opacity=String(t)}set content(t){let e;/^(https?|ipfs):\/\//.test(t)?(e=document.createElement("img"),e.src=t):(e=document.createElement("span"),e.textContent=t),e.className="emoji",this.elem.replaceChildren(e)}set time(t){if(t>=this.start&&t<=this.end){const e=(t-this.start)/(this.end-this.start),h=`${this.initial.x+Math.cos(6*Math.PI*e)}%`;this.left=h;const u=`${this.initial.y-this.height*e}%`;this.top=u,this.opacity=1-e}else this.opacity=0}toString(){return`Drifter(${this.start}–${this.end}, <${this.initial.x}, ${this.initial.y}>, ${this.elem.textContent})`}}const J="_reactor_1ta6m_1",V="_video_1ta6m_2",Z="_overlay_1ta6m_1",ee="_drifting_1ta6m_18",te="_home_1ta6m_34",k={reactor:J,video:V,overlay:Z,drifting:ee,"onscreen-keymap":"_onscreen-keymap_1ta6m_1",home:te},ne=()=>{var L;const i=n.useRef(null),t=n.useRef(null),e=n.useRef(null),h=n.useRef([]),[u,l]=n.useState(null),[y,x]=n.useState(!0),[E,p]=n.useState(),[w,_]=n.useState(!1),{supabase:o,error:C}=O();C&&console.error({supaError:C});const{uuid:v}=U(),{error:N,data:f}=F({queryKey:["Reactor",{uuid:v,supabase:o}],queryFn:async()=>{if(!o)throw new Error("Supabase not initialized.");const{data:r,error:a}=await(o==null?void 0:o.from("videos").select("*, feedback_groups (id, title)").eq("id",v).single())??{};if(a)throw a;return r},enabled:!!o});console.debug({videoConfig:f}),N&&console.error({queryError:N});const M=n.useCallback(()=>{if(e.current){const r=e.current.currentTime*1e3;h.current.forEach(a=>a.time=r)}},[]);W(M);const d=n.useCallback(r=>{var a;if(!e.current)throw new Error("<video> ref is not set.");switch(r.key){case"Escape":{document.addEventListener("keyup",d),(a=i.current)==null||a.close(),_(!1),y&&e.current.play();break}case"e":{l({time:e.current.currentTime*1e3}),_(!0);break}case" ":{e.current.paused?e.current.play():e.current.pause();break}case"ArrowLeft":case"ArrowRight":{let s=10;r.shiftKey&&(s*=2),r.ctrlKey&&(s/=2),r.key==="ArrowLeft"&&(s*=-1),e.current.currentTime+=e.current.duration/s;break}case"ArrowUp":case"ArrowDown":{let s=1;r.shiftKey&&(s*=2),r.ctrlKey&&(s/=2),r.key==="ArrowDown"&&(s*=-1),e.current.currentTime+=s;break}case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":{const s=(()=>{switch(r.key){case"0":return .25;case"1":return .5;case"2":return 1;case"3":return 1.25;case"4":return 1.5;case"5":return 2;case"6":return 4;case"7":return 8;case"8":return 10;case"9":return 20;default:return 1}})();e.current.playbackRate=s,z(`Playback ⨯${s}`);break}}},[y]),K=n.useCallback(r=>{var g;if(!e.current)throw new Error("<video> not found.");const a={x:r.clientX,y:r.clientY},s={x:a.x/e.current.clientWidth*100,y:a.y/e.current.clientHeight*100};p(s),l({at:s,time:e.current.currentTime*1e3}),x(!e.current.paused),e.current.pause(),document.removeEventListener("keyup",d),(g=i.current)==null||g.showModal()},[d]),D=n.useCallback(()=>{var r;document.addEventListener("keyup",d),(r=i.current)==null||r.close()},[d]),I=async(r,a)=>{if(a.stopPropagation(),!u)throw new Error("Emoji selected without initial config.");if(!u.at||!u.time)throw new Error("Emoji selected without complete config.");if(!e.current)throw new Error("<video> ref is not set.");if(!t.current)throw new Error("Overlay ref is not set.");const s=u.time,g=u.time+4*1e3,j=u.at,b=r.image;if(!b)throw new Error("Reaction has no emoji.");if(h.current.push(new B({start:s,end:g,initial:j,content:b,parent:t.current,className:k.drifting})),l(null),y&&e.current.play(),o){const{data:S}=await o.from("feedbacks").select().eq("image",b).single();let R=S==null?void 0:S.id;if(!R){const{data:$,error:A}=await o.from("feedbacks").insert({image:b}).select().single();if(R=$.id,A)throw A}await(o==null?void 0:o.from("reactions").insert({start_time:new Date(s).toISOString().split("T").at(-1),end_time:new Date(g).toISOString().split("T").at(-1),initial_x:Math.round(j.x),initial_y:Math.round(j.y),video_id:v,feedback_id:R}))}};n.useEffect(()=>(document.addEventListener("keyup",d),()=>{document.removeEventListener("keyup",d)}),[d]);const P=r=>{var a;if(!e.current)throw new Error("<video> ref is not set.");p(r),_(!1),l({...u,at:r}),x(!e.current.paused),e.current.pause(),(a=i.current)==null||a.showModal()};return c.jsxs("article",{id:k.reactor,children:[c.jsx(G,{}),c.jsxs("section",{className:k.video,children:[f?c.jsxs("video",{controls:!0,muted:!0,autoPlay:!0,ref:e,children:[c.jsx("source",{src:f.url}),c.jsx("track",{default:!0,src:"animated.vtt",kind:"subtitles",label:"Animated"})]}):c.jsx("h3",{children:"Loading…"}),c.jsx("div",{id:k.overlay,ref:t,onClick:K}),c.jsx(X,{active:w,onSelect:P})]}),c.jsx(H,{to:"/",className:k.home,children:c.jsx(Q,{})}),c.jsx(Y,{feedbackGroupIds:(L=f==null?void 0:f.feedback_groups)==null?void 0:L.map(({id:r})=>r),ref:i,onSelect:I,onClose:D,center:E})]})};export{ne as Reactor,ne as default};
