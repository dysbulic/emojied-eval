var O=Object.defineProperty;var U=(i,r,e)=>r in i?O(i,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[r]=e;var y=(i,r,e)=>(U(i,typeof r!="symbol"?r+"":r,e),e);import{r as a,u as F,c as W,d as z,t as M,e as G,_ as H,j as c,I as Q,b as X,f as Y}from"./index-CLGkLqZk.js";import{K as B,R as J}from"./index-DUfFQ6HI.js";class K{constructor({parent:r,element:e,start:m,end:u,initial:l,height:w,content:x,className:E}){y(this,"elem");y(this,"start");y(this,"end");y(this,"initial");y(this,"height");var g;if(e??(e=(()=>{const k=document.createElement("span");return k.classList.add(E),r.appendChild(k),k})()),this.elem=e,this.content=x,this.opacity="0",this.start=m??Number(e.dataset.start),isNaN(this.start))throw new Error("`.drifting` must have a `data-start` time or `Drifting` must have `{start}`.");this.end=u??Number(e.dataset.end??this.start+2500),(g=e.dataset).x??(g.x=String(20+Math.random()*60)),this.initial={x:(l==null?void 0:l.x)??Number(e.dataset.x),y:(l==null?void 0:l.y)??Number(e.dataset.y??0)},this.height=w??Number(e.dataset.height??40)}set left(r){this.elem.style.left=r}set top(r){this.elem.style.top=r}set opacity(r){this.elem.style.opacity=String(r)}set content(r){let e;/^(https?|ipfs):\/\//.test(r)?(e=document.createElement("img"),e.src=r):(e=document.createElement("span"),e.textContent=r),e.className="emoji",this.elem.replaceChildren(e)}set time(r){if(r>=this.start&&r<=this.end){const e=(r-this.start)/(this.end-this.start),m=`${this.initial.x+Math.cos(6*Math.PI*e)}%`;this.left=m;const u=`${this.initial.y-this.height*e}%`;this.top=u,this.opacity=1-e}else this.opacity=0}toString(){return`Drifter(${this.start}–${this.end}, <${this.initial.x}, ${this.initial.y}>, ${this.elem.textContent})`}}const V="_reactor_1ta6m_1",Z="_video_1ta6m_2",ee="_overlay_1ta6m_1",te="_drifting_1ta6m_18",re="_home_1ta6m_34",p={reactor:V,video:Z,overlay:ee,drifting:te,"onscreen-keymap":"_onscreen-keymap_1ta6m_1",home:re},ie=()=>{var L;const i=a.useRef(null),r=a.useRef(null),e=a.useRef(null),m=a.useRef([]),[u,l]=a.useState(null),[w,x]=a.useState(!0),[E,g]=a.useState(),[k,v]=a.useState(!1),{supabase:o,error:R}=F();R&&console.error({supaError:R});const{uuid:S}=W(),{error:C,data:d}=z({enabled:!!o,queryKey:["Reactor",{uuid:S,supabase:o}],queryFn:async()=>{if(!o)throw new Error("Supabase not initialized.");const{data:t,error:n}=await(o==null?void 0:o.from("videos").select(`
          *,
          feedback_groups (id, title),
          reactions (
            start_time, end_time,
            initial_x, initial_y,
            feedbacks (*)
          )
        `).eq("id",S).single())??{};if(n)throw n;return t}});C&&console.error({queryError:C}),console.debug({videoConfig:d}),a.useEffect(()=>{d&&(m.current=d.reactions.map(t=>{if(!r.current)throw new Error("Overlay ref is not set.");const n=M(t.start_time)*1e3,s=M(t.end_time)*1e3,h={x:t.initial_x,y:t.initial_y},_=t.feedbacks.image;return new K({start:n,end:s,initial:h,content:_,parent:r.current,className:p.drifting})}))},[d]);const D=a.useCallback(()=>{if(e.current){const t=e.current.currentTime*1e3;m.current.forEach(n=>n.time=t)}},[]);G(D);const f=a.useCallback(t=>{var n;if(!e.current)throw new Error("<video> ref is not set.");switch(t.key){case"Escape":{document.addEventListener("keyup",f),(n=i.current)==null||n.close(),v(!1),w&&e.current.play();break}case"e":{l({time:e.current.currentTime*1e3}),v(!0);break}case" ":{e.current.paused?e.current.play():e.current.pause();break}case"ArrowLeft":case"ArrowRight":{let s=10;t.shiftKey&&(s*=2),t.ctrlKey&&(s/=2),t.key==="ArrowLeft"&&(s*=-1),e.current.currentTime+=e.current.duration/s;break}case"ArrowUp":case"ArrowDown":{let s=1;t.shiftKey&&(s*=2),t.ctrlKey&&(s/=2),t.key==="ArrowDown"&&(s*=-1),e.current.currentTime+=s;break}case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":{const s=(()=>{switch(t.key){case"0":return .25;case"1":return .5;case"2":return 1;case"3":return 1.25;case"4":return 1.5;case"5":return 2;case"6":return 4;case"7":return 8;case"8":return 10;case"9":return 20;default:return 1}})();e.current.playbackRate=s,H(`Playback ⨯${s}`);break}}},[w]);a.useEffect(()=>(document.addEventListener("keyup",f),()=>{document.removeEventListener("keyup",f)}),[f]);const I=a.useCallback(t=>{var h;if(!e.current)throw new Error("<video> not found.");const n={x:t.clientX,y:t.clientY},s={x:n.x/e.current.clientWidth*100,y:n.y/e.current.clientHeight*100};g(s),l({at:s,time:e.current.currentTime*1e3}),x(!e.current.paused),e.current.pause(),document.removeEventListener("keyup",f),(h=i.current)==null||h.showModal()},[f]),P=a.useCallback(()=>{var t;document.addEventListener("keyup",f),(t=i.current)==null||t.close()},[f]),T=async(t,n)=>{if(n.stopPropagation(),!u)throw new Error("Emoji selected without initial config.");if(!u.at||!u.time)throw new Error("Emoji selected without complete config.");if(!e.current)throw new Error("<video> ref is not set.");if(!r.current)throw new Error("Overlay ref is not set.");const s=u.time,h=u.time+4*1e3,_=u.at,b=t.image;if(!b)throw new Error("Reaction has no emoji.");if(m.current.push(new K({start:s,end:h,initial:_,content:b,parent:r.current,className:p.drifting})),l(null),w&&e.current.play(),o){const{data:j}=await o.from("feedbacks").select().eq("image",b).single();let N=j==null?void 0:j.id;if(!N){const{data:q,error:A}=await o.from("feedbacks").insert({image:b}).select().single();if(N=q.id,A)throw A}await(o==null?void 0:o.from("reactions").insert({start_time:new Date(s).toISOString().split("T").at(-1),end_time:new Date(h).toISOString().split("T").at(-1),initial_x:Math.round(_.x),initial_y:Math.round(_.y),video_id:S,feedback_id:N}))}},$=t=>{var n;if(!e.current)throw new Error("<video> ref is not set.");g(t),v(!1),l({...u,at:t}),x(!e.current.paused),e.current.pause(),(n=i.current)==null||n.showModal()};return c.jsxs("article",{id:p.reactor,children:[c.jsx(Q,{}),c.jsxs("section",{className:p.video,children:[d?c.jsxs("video",{controls:!0,muted:!0,autoPlay:!0,ref:e,children:[c.jsx("source",{src:d.url}),c.jsx("track",{default:!0,src:"animated.vtt",kind:"subtitles",label:"Animated"})]}):c.jsx("h3",{children:"Loading…"}),c.jsx("div",{id:p.overlay,ref:r,onClick:I}),c.jsx(B,{active:k,onSelect:$})]}),c.jsx(X,{to:"/",className:p.home,children:c.jsx(Y,{})}),c.jsx(J,{feedbackGroupIds:(L=d==null?void 0:d.feedback_groups)==null?void 0:L.map(({id:t})=>t),ref:i,onSelect:T,onClose:P,center:E})]})};export{ie as Reactor,ie as default};
