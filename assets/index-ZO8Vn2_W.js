import{r as i,j as e,L as A}from"./index-RDPsrnET.js";import{u as T,e as M}from"./utils-jCoBhz4w.js";import{f}from"./form.module-ntuGhauS.js";import{H as V}from"./index-3Q0IZbK-.js";import{u as q}from"./useQuery-XxS-53U_.js";import"./index-AQ3BiMjx.js";const Q=i.forwardRef(({feedback:n,onClose:d,className:y},o)=>{const[r,g]=i.useState(n==null?void 0:n.name),[w,v]=i.useState(n==null?void 0:n.image),[h,l]=i.useState(n==null?void 0:n.description),_=i.useRef(null),{supabase:m}=T();console.debug({feedback:n,description:h}),i.useEffect(()=>{g(n==null?void 0:n.name),v(n==null?void 0:n.image),l(n==null?void 0:n.description)},[n]);const b=()=>{var c,x;d==null||d(),o instanceof Function||(c=o==null?void 0:o.current)==null||c.close(),(x=_.current)==null||x.reset()},s=async c=>{var j;if(!m)throw new Error("Supabase not defined.");const x=c.currentTarget.elements,N={image:x.image.value,name:x.name.value,description:x.description.value,id:((j=x.id)==null?void 0:j.value)||void 0};await m.from("feedbacks").upsert(N),b()};return e.jsx("dialog",{ref:o,className:y,children:e.jsxs("form",{method:"dialog",className:f.form,ref:_,onSubmit:s,children:[(n==null?void 0:n.id)&&e.jsx("input",{type:"hidden",name:"id",value:n.id}),e.jsxs("label",{children:[e.jsx("h3",{children:"Image"}),e.jsx("input",{id:"image",required:!0,value:w??"",onChange:({target:{value:c}})=>v(c)})]}),e.jsxs("label",{children:[e.jsx("h3",{children:"Name"}),e.jsx("input",{id:"name",required:!0,value:r??"",onChange:({target:{value:c}})=>g(c)})]}),e.jsxs("label",{children:[e.jsx("h3",{children:"Description"}),e.jsx("textarea",{id:"description",value:h??"",onChange:({target:{value:c}})=>l(c)})]}),w&&M(w,{className:f.center}),e.jsxs("section",{className:f.buttons,children:[e.jsx("button",{type:"button",className:f.cancel,onClick:b,children:"Cancel"}),e.jsx("button",{className:f.submit,children:n?"Update":"Create"})]})]})})}),z=Q,P="_olTable_t28na_1",W="_center_t28na_44",X="_header_t28na_49",Y="_newGroup_t28na_64",Z="_description_t28na_68",ee="_edit_t28na_1",S={olTable:P,new:"_new_t28na_64",center:W,header:X,"col-3":"_col-3_t28na_60",newGroup:Y,description:Z,edit:ee},te="_form_16dsd_1",ne="_instructions_16dsd_1",U={form:te,instructions:ne},se=i.forwardRef(({feedback:n,onClose:d,className:y},o)=>{const r=i.useRef(null),{supabase:g}=T(),w=()=>{var h,l;d==null||d(),o instanceof Function||(h=o==null?void 0:o.current)==null||h.close(),(l=r.current)==null||l.reset()},v=async h=>{var m;if(!g)throw new Error("Supabase not defined.");const l=h.currentTarget.elements,_={image:l.image.value,name:l.name.value,description:l.description.value,id:((m=l.id)==null?void 0:m.value)||void 0};await g.from("feedbacks").upsert(_),w()};return e.jsx("dialog",{className:y,ref:o,children:e.jsxs("form",{method:"dialog",className:U.form,ref:r,onSubmit:v,children:[e.jsx("h2",{children:"Bulk Add Feedbacks"}),e.jsxs("aside",{id:U.instructions,children:[e.jsxs("p",{children:["Format may either be"," ",e.jsx(A,{to:"",title:"JavaScript Object Notation v5",children:"JSON5 Array"}),", or"," ",e.jsx(A,{to:"",title:"Comma Separated Values",children:"headered CSV"}),"."]}),e.jsxs("p",{children:["The headers / keys are:",e.jsxs("ul",{children:[e.jsx("li",{children:e.jsx("code",{children:"image-url"})}),e.jsx("li",{children:e.jsx("code",{children:"name"})}),e.jsx("li",{children:e.jsx("code",{children:"feedback-group-ids"})}),e.jsx("li",{children:e.jsx("code",{children:"description"})})]})]})]}),e.jsx("textarea",{id:"text",placeholder:`image-url, name, feedback-group-ids, description
https://code.trwb.live/logo.svg, Swirling Mobster, , Â¡Mama Mia!: Â¡Look at it!
https://trwb.live/logo.svg, The Big T, , "It's a bigun!"`}),e.jsxs("section",{className:f.buttons,children:[e.jsx("button",{type:"button",className:f.cancel,onClick:w,children:"Cancel"}),e.jsx("button",{className:f.submit,children:n?"Update":"Create"})]})]})})}),ie=se,ue=()=>{const[n,d]=i.useState(),[y,o]=i.useState(),[r,g]=i.useState(),[w,v]=i.useState(),[h,l]=i.useState(),[_,m]=i.useState({}),b=i.useRef(null),{supabase:s}=T(),{data:c,isLoading:x,refetch:N}=q({queryKey:["FeedbackGroups","feedbacks",{supabase:s}],queryFn:async()=>{if(!s)throw new Error("No `supabase` defined.");const{data:t}=await s.from("feedbacks").select();return t},enabled:!!s}),{data:j,isLoading:B,refetch:L}=q({queryKey:["FeedbackGroups","groups",{supabase:s}],queryFn:async()=>{if(!s)throw new Error("No `supabase` defined.");const{data:t}=await s.from("feedback_groups").select().order("title");return t},enabled:!!s}),{data:F,isLoading:I}=q({queryKey:["FeedbackGroups","selected",{uuid:r,supabase:s}],queryFn:async()=>{if(!s)throw new Error("No `supabase` defined.");if(!r)return new Set;const{data:t}=await s.from("feedbacks_groups").select(`
          feedbacks (id)
        `).eq("group_id",r);return new Set(t==null?void 0:t.map(({feedbacks:a})=>Array.isArray(a)?a.map(({id:u})=>u):a.id).flat())},enabled:!!s&&r!=null,initialData:new Set});i.useEffect(()=>{F&&m(()=>{const t={};for(const a of F)t[a]=!0;return t})},[F]);const G=i.useRef(null),H=async()=>{var t;l(void 0),(t=G.current)==null||t.showModal()},$=t=>{var a;l(t),(a=G.current)==null||a.showModal()},R=i.useCallback(()=>{N()},[N]),k=async t=>{t.preventDefault();const u=t.currentTarget.elements.group.value;g(u);const p=j==null?void 0:j.find(({id:C})=>C===u);if(u&&!p)throw new Error(`Group "${u}" not found.`);d(p==null?void 0:p.title),o(p==null?void 0:p.description)},D=()=>{g(void 0),v(void 0),d(void 0),o(void 0),m({})},K=async t=>{if(!s)throw new Error("Supabase not defined.");t.preventDefault();const a=t.currentTarget.elements,u=Object.values(a.grouped).filter(({checked:E})=>E);if(u.length===0)throw new Error("No reactions selected.");const p={title:a.title.value,description:a.description.value,id:void 0};r&&(p.id=r);const{data:C}=await s.from("feedback_groups").upsert(p).select().single()??{},J=u.map(({value:E})=>({feedback_id:E,group_id:C.id}));await(s==null?void 0:s.from("feedbacks_groups").delete().eq("group_id",C.id)),await(s==null?void 0:s.from("feedbacks_groups").insert(J)),D(),L()},O=async t=>{if(!s)throw new Error("`supabase` not defined.");await s.from("feedback_groups").delete().eq("id",t),D(),L()};return e.jsxs("section",{children:[e.jsxs(V,{children:[e.jsx("h1",{children:"Reactions"}),e.jsx("button",{onClick:H,className:"square",children:"âž•"})]}),e.jsx(z,{ref:G,feedback:h,onClose:R}),e.jsx(ie,{ref:b,onClose:R}),B?e.jsx("p",{children:"Loadingâ€¦"}):e.jsxs("form",{onSubmit:k,id:S.edit,children:[e.jsxs("select",{id:"group",value:w??"",onChange:({target:{value:t}})=>{v(t)},children:[e.jsx("option",{value:"",children:"None"}),j==null?void 0:j.map(t=>e.jsx("option",{value:t.id,children:t.title},t.id))]}),e.jsx("button",{children:"Edit Group"}),e.jsx("button",{type:"button",onClick:()=>{var t;(t=b.current)==null||t.showModal()},children:"Bulk Add Groups"})]}),e.jsxs("form",{onSubmit:K,id:S.new,children:[x||r&&I?e.jsx("p",{children:"Loadingâ€¦"}):e.jsx(e.Fragment,{children:c==null?void 0:c.map(t=>e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",id:"grouped",value:t.id,checked:_[t.id]??!1,onChange:({target:{checked:a}})=>m(u=>({...u,[t.id]:a}))}),M(t.image),e.jsx("h2",{children:t.name}),e.jsx("div",{className:S.center,children:t.description}),e.jsx("button",{type:"button",onClick:()=>$(t),children:"ðŸ–‰"})]},t.id))}),e.jsxs("section",{className:S.newGroup,children:[r&&e.jsx("input",{type:"hidden",id:"uuid",value:r}),e.jsx("input",{id:"title",required:!0,placeholder:"Title",value:n??"",onChange:({target:{value:t}})=>d(t)}),e.jsx("input",{id:"description",className:S.description,placeholder:"Description",value:y??"",onChange:({target:{value:t}})=>o(t)}),e.jsxs("button",{children:[r?"Update":"Create"," Group"]}),e.jsx("button",{type:"button",onClick:D,children:"Cancel"}),r&&e.jsx("button",{type:"button",onClick:()=>O(r),children:"Delete Group"})]})]})]})};export{ue as FeedbackGroups,ue as default};
