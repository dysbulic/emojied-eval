import{r as o,j as t}from"./index-D4CTEBZ-.js";import{u as U,e as L}from"./utils-8aVrX_ZJ.js";import{f as v}from"./form.module-NCFyfnK-.js";import{H as Q}from"./index-LiItE4P8.js";import{u as b}from"./useQuery-cppXtXyb.js";import"./index-rwhNsM-d.js";const z=o.forwardRef(({feedback:n,onClose:m,className:N},u)=>{const[r,g]=o.useState(n==null?void 0:n.name),[x,j]=o.useState(n==null?void 0:n.image),[f,w]=o.useState(n==null?void 0:n.description),S=o.useRef(null),{supabase:h}=U();console.debug({feedback:n,description:f}),o.useEffect(()=>{g(n==null?void 0:n.name),j(n==null?void 0:n.image),w(n==null?void 0:n.description)},[n]);const s=()=>{var a,l;m==null||m(),u instanceof Function||(a=u==null?void 0:u.current)==null||a.close(),(l=S.current)==null||l.reset()},_=async a=>{var C;if(!h)throw new Error("Supabase not defined.");const l=a.currentTarget.elements,p={image:l.image.value,name:l.name.value,description:l.description.value,id:((C=l.id)==null?void 0:C.value)||void 0};await h.from("feedbacks").upsert(p),s()};return t.jsx("dialog",{ref:u,className:N,children:t.jsxs("form",{method:"dialog",className:v.form,ref:S,onSubmit:_,children:[(n==null?void 0:n.id)&&t.jsx("input",{type:"hidden",name:"id",value:n.id}),t.jsxs("label",{children:[t.jsx("h3",{children:"Image"}),t.jsx("input",{id:"image",required:!0,value:x??"",onChange:({target:{value:a}})=>j(a)})]}),t.jsxs("label",{children:[t.jsx("h3",{children:"Name"}),t.jsx("input",{id:"name",required:!0,value:r??"",onChange:({target:{value:a}})=>g(a)})]}),t.jsxs("label",{children:[t.jsx("h3",{children:"Description"}),t.jsx("textarea",{id:"description",value:f??"",onChange:({target:{value:a}})=>w(a)})]}),x&&L(x,{className:v.center}),t.jsxs("section",{className:v.buttons,children:[t.jsx("button",{type:"button",className:v.cancel,onClick:s,children:"Cancel"}),t.jsx("button",{className:v.submit,children:n?"Update":"Create"})]})]})})}),B=z,J="_olTable_t28na_1",P="_center_t28na_44",V="_header_t28na_49",W="_newGroup_t28na_64",X="_description_t28na_68",Y="_edit_t28na_1",y={olTable:J,new:"_new_t28na_64",center:P,header:V,"col-3":"_col-3_t28na_60",newGroup:W,description:X,edit:Y},ie=()=>{const[n,m]=o.useState(),[N,u]=o.useState(),[r,g]=o.useState(),[x,j]=o.useState(),[f,w]=o.useState(),[S,h]=o.useState({}),{supabase:s}=U(),{data:_,isLoading:a,refetch:l}=b({queryKey:["FeedbackGroups","feedbacks",{supabase:s}],queryFn:async()=>{if(!s)throw new Error("No `supabase` defined.");const{data:e}=await s.from("feedbacks").select();return e},enabled:!!s}),{data:p,isLoading:C,refetch:T}=b({queryKey:["FeedbackGroups","groups",{supabase:s}],queryFn:async()=>{if(!s)throw new Error("No `supabase` defined.");const{data:e}=await s.from("feedback_groups").select().order("title");return e},enabled:!!s}),{data:E,isLoading:R}=b({queryKey:["FeedbackGroups","selected",{uuid:r,supabase:s}],queryFn:async()=>{if(!s)throw new Error("No `supabase` defined.");if(!r)return new Set;const{data:e}=await s.from("feedbacks_groups").select(`
          feedbacks (id)
        `).eq("group_id",r);return new Set(e==null?void 0:e.map(({feedbacks:i})=>Array.isArray(i)?i.map(({id:c})=>c):i.id).flat())},enabled:!!s&&r!=null,initialData:new Set});o.useEffect(()=>{E&&h(()=>{const e={};for(const i of E)e[i]=!0;return e})},[E]);const F=o.useRef(null),H=async()=>{var e;w(void 0),(e=F.current)==null||e.showModal()},I=e=>{var i;w(e),(i=F.current)==null||i.showModal()},K=o.useCallback(()=>{l()},[l]),A=async e=>{e.preventDefault();const c=e.currentTarget.elements.group.value;g(c);const d=p==null?void 0:p.find(({id:G})=>G===c);if(c&&!d)throw new Error(`Group "${c}" not found.`);m(d==null?void 0:d.title),u(d==null?void 0:d.description)},q=()=>{g(void 0),j(void 0),m(void 0),u(void 0),h({})},M=async e=>{if(!s)throw new Error("Supabase not defined.");e.preventDefault();const i=e.currentTarget.elements,c=Object.values(i.grouped).filter(({checked:D})=>D);if(c.length===0)throw new Error("No reactions selected.");const d={title:i.title.value,description:i.description.value,id:void 0};r&&(d.id=r);const{data:G}=await s.from("feedback_groups").upsert(d).select().single()??{},O=c.map(({value:D})=>({feedback_id:D,group_id:G.id}));await(s==null?void 0:s.from("feedbacks_groups").delete().eq("group_id",G.id)),await(s==null?void 0:s.from("feedbacks_groups").insert(O)),q(),T()},$=async e=>{if(!s)throw new Error("`supabase` not defined.");await s.from("feedback_groups").delete().eq("id",e),q(),T()};return t.jsxs("section",{children:[t.jsxs(Q,{children:[t.jsx("h1",{children:"Reactions"}),t.jsx("button",{onClick:H,className:"square",children:"âž•"})]}),t.jsx(B,{ref:F,feedback:f,onClose:K}),C?t.jsx("p",{children:"Loadingâ€¦"}):t.jsxs("form",{onSubmit:A,id:y.edit,children:[t.jsxs("select",{id:"group",value:x??"",onChange:({target:{value:e}})=>{j(e)},children:[t.jsx("option",{value:"",children:"None"}),p==null?void 0:p.map(e=>t.jsx("option",{value:e.id,children:e.title},e.id))]}),t.jsx("button",{children:"Edit Group"})]}),t.jsxs("form",{onSubmit:M,id:y.new,children:[a||r&&R?t.jsx("p",{children:"Loadingâ€¦"}):t.jsx(t.Fragment,{children:_==null?void 0:_.map(e=>t.jsxs("label",{children:[t.jsx("input",{type:"checkbox",id:"grouped",value:e.id,checked:S[e.id]??!1,onChange:({target:{checked:i}})=>h(c=>({...c,[e.id]:i}))}),L(e.image),t.jsx("h2",{children:e.name}),t.jsx("div",{className:y.center,children:e.description}),t.jsx("button",{type:"button",onClick:()=>I(e),children:"ðŸ–‰"})]},e.id))}),t.jsxs("section",{className:y.newGroup,children:[r&&t.jsx("input",{type:"hidden",id:"uuid",value:r}),t.jsx("input",{id:"title",required:!0,placeholder:"Title",value:n??"",onChange:({target:{value:e}})=>m(e)}),t.jsx("input",{id:"description",className:y.description,placeholder:"Description",value:N??"",onChange:({target:{value:e}})=>u(e)}),t.jsxs("button",{children:[r?"Update":"Create"," Group"]}),t.jsx("button",{type:"button",onClick:q,children:"Cancel"}),r&&t.jsx("button",{type:"button",onClick:()=>$(r),children:"Delete Group"})]})]})]})};export{ie as FeedbackGroups,ie as default};
