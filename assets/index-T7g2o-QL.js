import{r as a,u as C,d as T,j as e,i as p,H as S,b as L}from"./index-whC2bFQp.js";const O="_form_1b9hj_1",R="_buttons_1b9hj_36",$="_noneOption_1b9hj_46",D="_split_1b9hj_52",g={form:O,buttons:R,noneOption:$,split:D},z=a.forwardRef(({video:t,onClose:c},r)=>{var n,m;const{supabase:l}=C(),h=a.useRef(null),[i,d]=a.useState(),u=a.useCallback(()=>{var s,o;(s=h.current)==null||s.reset(),r instanceof Function||(o=r==null?void 0:r.current)==null||o.close(),c==null||c()},[r,c]);a.useEffect(()=>{if(!(r instanceof Function)){const s=u,o=r==null?void 0:r.current;return o==null||o.addEventListener("close",s),()=>o==null?void 0:o.removeEventListener("close",s)}},[u,r]);const b=async s=>{if(!l)throw new Error("Supabase not defined.");const o=s.currentTarget.elements,w={id:t==null?void 0:t.id,url:o.url.value,title:o.title.value,description:o.description.value},y=document.createElement("video");w.duration=await new Promise(F=>{y.addEventListener("loadedmetadata",()=>{var V;F(((V=new Date(y.duration*1e3).toISOString().split("T").at(-1))==null?void 0:V.replace(/\w$/g,""))??null)}),y.src=w.url});const{data:E,error:N}=await l.from("videos").upsert(w).select("id").single()??{};if(N)throw N;const q=o.group.value;await l.from("feedback_groups_videos").delete().eq("video_id",E.id),q&&await l.from("feedback_groups_videos").upsert({video_id:E.id,group_id:q}),u()},{isLoading:f,error:_,data:j}=T({queryKey:["VideoForm",{supabase:l}],enabled:!!l,queryFn:async()=>{const{data:s,error:o}=await(l==null?void 0:l.from("feedback_groups").select())??{};if(o)throw o;return s}});if(_)throw _;const x=(m=(n=t==null?void 0:t.feedback_groups)==null?void 0:n[0])==null?void 0:m.id;return a.useEffect(()=>{console.debug({fbg:x}),d(x)},[x]),e.jsx("dialog",{ref:r,className:g.dialog,children:e.jsxs("form",{onSubmit:b,method:"dialog",className:p.form,ref:h,children:[e.jsxs("label",{children:[e.jsx("h3",{children:"URL"}),e.jsx("input",{id:"url",defaultValue:(t==null?void 0:t.url)??"",required:!0})]}),e.jsxs("label",{children:[e.jsx("h3",{children:"Title"}),e.jsx("input",{id:"title",defaultValue:(t==null?void 0:t.title)??"",required:!0})]}),e.jsxs("label",{children:[e.jsx("h3",{children:"Description"}),e.jsx("textarea",{id:"description",defaultValue:(t==null?void 0:t.description)??""})]}),e.jsxs("label",{children:[e.jsx("h3",{className:g.split,children:"Feedback Group"}),f?e.jsx("p",{children:"Loadingâ€¦"}):e.jsxs("select",{id:"group",value:i??"",onChange:({currentTarget:{value:s}})=>d(s),children:[e.jsx("option",{value:"",className:g.noneOption,children:"None"}),j==null?void 0:j.map(s=>e.jsx("option",{value:s.id,children:s.title},s.id))]})]}),e.jsxs("div",{className:p.buttons,children:[e.jsx("button",{type:"button",onClick:u,className:p.cancel,children:"Cancel"}),e.jsx("button",{className:p.submit,children:t?"Update":"Create"})]})]})})}),G=z,H=t=>T({queryKey:["Videos",t],enabled:!!t,queryFn:async()=>{const{data:c,error:r}=await(t==null?void 0:t.from("videos").select("*, feedback_groups (*)"))??{};if(r)throw r;return c}}),K="_header_stgzj_1",U="_none_stgzj_6",I="_olTable_stgzj_12",k={header:K,none:U,olTable:I},P=()=>{const t=a.useRef(null),{supabase:c,error:r}=C(),{isLoading:l,error:h,data:i,refetch:d}=H(c),[u,b]=a.useState(null),f=async()=>{var n;(n=t.current)==null||n.showModal()},_=a.useCallback(()=>{b(null),d()},[d]),j=n=>{const m=i==null?void 0:i.find(s=>s.id===n);if(!m)throw new Error(`No video found with id: "${n}".`);b(m),f()},x=async n=>{await(c==null?void 0:c.from("videos").delete().eq("id",n)),d()};if(r)throw r;if(h)throw h;return e.jsxs("article",{id:k.outer,children:[e.jsxs(S,{children:[e.jsx("h1",{children:"Videos"}),e.jsx("button",{onClick:f,className:"square",children:"âž•"})]}),e.jsx(G,{video:u,onClose:_,ref:t}),e.jsx("main",{className:k.olTable,children:l?e.jsx("p",{children:"Loadingâ€¦"}):i&&i.length===0?e.jsxs("section",{className:k.none,children:[e.jsx("p",{children:"No videos found."}),e.jsx("button",{onClick:f,children:"Create One"})]}):e.jsx("ol",{children:i==null?void 0:i.map(n=>e.jsxs("li",{children:[e.jsx("h2",{children:e.jsx(L,{to:`/eval/${n.id}`,children:n.title})}),e.jsx("div",{children:n.description}),e.jsxs("nav",{className:p.options,children:[e.jsx("button",{onClick:()=>j(n.id),children:"ðŸ–‰"}),e.jsx("button",{onClick:()=>x(n.id),children:"âž–"}),e.jsx(L,{to:`/score/${n.id}`,children:"ðŸŽ¼"})]})]},n.id))})})]})};export{P as Videos,P as default};
